<!DOCTYPE html>
<html lang="fr">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>index</title>

<style>
body {
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background-color: #f4f9f9;
  color: #333;
  margin: 0;
  padding: 20px;
  line-height: 1.6;
}

h2 {
  font-size: 1.4em;
  padding: 8px 14px;
  border-radius: 10px;
  color: #fff;
  margin-top: 30px;
}

h2:nth-of-type(1) { background-color: #7ec8e3; }
h2:nth-of-type(2) { background-color: #a2d9ce; }
h2:nth-of-type(3) { background-color: #f7d794; }
h2:nth-of-type(4) { background-color: #c5b3e6; }
h2:nth-of-type(5) { background-color: #81c784; }

label {
  display: block;
  margin-top: 10px;
  font-weight: 500;
}

input, select, textarea {
  width: 100%;
  padding: 8px 10px;
  margin-top: 4px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  font-size: 15px;
  background-color: #fff;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #7ec8e3;
  box-shadow: 0 0 0 3px rgba(126,200,227,0.2);
}

/* === Champs courts === */
#date, 
#heure-rv, 
#duree, 
#ibp, 
#technicite, 
#risque {
  width: 180px;
}

#trajet-km, 
#cout-autoroute {
  width: 140px;
}

#organisateur h2 {
  width: 300px;
  color: #000;
}

/* Alignement horizontal pour certains groupes */
div[style*="flex"] input,
div[style*="flex"] select {
  flex: 0 0 auto;
}

/* === Boutons === */
button {
  padding: 10px 22px;
  background-color: #7ec8e3;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s ease;
}

button:hover {
  background-color: #5fb0cf;
}

/* === Containers === */
.resume-container {
  border: 1px solid #ccc;
  background-color: #fff;
  padding: 15px;
  margin-top: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

section {
  background-color: #fff;
  border-radius: 12px;
  padding: 15px 20px;
  margin-top: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

hr {
  border: none;
  height: 1px;
  background-color: #e0e0e0;
  margin: 20px 0;
}

/* === R√©sum√© === */
#resultat {
  margin-top: 20px;
  padding: 15px;
  background-color: #ffffff;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  white-space: pre-wrap;
  text-align: left !important;
}

/* === Messages d'erreur et dropdown === */
.message-erreur {
  display: none;
  background-color: #e57373;
  color: white;
  padding: 5px;
  margin-top: 5px;
  border-radius: 4px;
}

.results {
  list-style: none;
  padding: 0;
  margin: 0;
  border: 1px solid #ccc;
  max-height: 180px;
  overflow: auto;
  background: #fff;
  position: absolute;
  width: calc(100% - 16px);
  z-index: 1000;
}

.results li {
  padding: 6px 8px;
  cursor: pointer;
}

.results li[aria-selected="true"] {
  background: #e6f4f1;
}

.dropdown-wrap {
  position: relative;
}
/* === Alignement √† gauche des pr√©visions m√©t√©o === */
#meteo-openmeteo,
#meteo-openmeteo * {
  text-align: left !important;
}
label.small-label {
  font-size: 16px;
  text-align: left !important;
}
</style>

<!-- Leaflet CSS & JS (added for interactive map selection) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>




<!-- Le reste du contenu HTML et JS reste inchang√© -->
<!-- Copie int√©grale du formulaire original avec ce style -->
<!-- (Colle ici tout ton code HTML et JavaScript d√©j√† pr√©sent dans newformrandos.htm) -->


<h2>Mod√®le Feuille de Route</h2>
<p>La s√©lection de votre rando s‚Äôeffectue d√®s la saisie des premi√®res lettres. Accents requis. Si elle n‚Äôappara√Æt pas, choisissez "Autre‚Ä¶" et saisissez votre titre.</p>

<label for="rechercheRando">Recherche de randonn√©e :</label>
<div class="dropdown-wrap">
  <input id="rechercheRando" placeholder="Tapez 2 lettres pour filtrer..." autocomplete="off" inputmode="text" aria-autocomplete="list" aria-controls="resultsList" aria-expanded="false">
  <ul id="resultsList" class="results" role="listbox" tabindex="-1" aria-label="R√©sultats" style="display:none"></ul>
</div>

<select id="nom" aria-hidden="true" style="display:none">
  <option value="" disabled="" selected="">-- Choisir une randonn√©e --</option>
  <!-- Exemple d'options, tu peux r√©injecter la liste compl√®te si besoin -->
  <option value="Alpes de Haute Provence">Alpes de Haute Provence</option>
  <option value="Ard√®che">Ard√®che</option>
  <option value="Calanques">Calanques</option>
  <option value="Dr√¥me (proven√ßale)">Dr√¥me (proven√ßale)</option>
  <option value="Gard">Gard</option>
  <option value="Luberon">Luberon</option>
  <option value="Vaucluse">Vaucluse</option>
  <option value="Var">Var</option>
  <option value="Aiguebelle">Aiguebelle</option>
  <option value="Alleins">Alleins</option>
  <option value="Alpilles">Alpilles</option>
  <option value="Alpilles : Les cr√™tes par le mont Gaussier">Alpilles : Les cr√™tes par le mont Gaussier</option>
  <option value="Alpilles tour d'Auge">Alpilles tour d'Auge</option>
  <option value="Alpilles, du lac de st Remy aux Baux">Alpilles, du lac de st Remy aux Baux</option>
  <option value="Arche du Portalas depuis Bonnieux">Arche du Portalas depuis Bonnieux</option>
  <option value="Au coeur de la Barthelasse">Au coeur de la Barthelasse</option>
  <option value="Autour de Sivergues">Autour de Sivergues</option>
  <option value="Autour du Ch√¢teau d'All√®gre">Autour du Ch√¢teau d'All√®gre</option>
  <option value="Badarel">Badarel</option>
  <option value="Balcons du Rh√¥ne au d√©part de Boulbon">Balcons du Rh√¥ne au d√©part de Boulbon</option>
  <option value="Baumes de Venise">Baumes de Venise</option>
  <option value="Baumeyrane les Baux">Baumeyrane les Baux</option>
  <option value="Baux, Lac de St R√©my">Baux, Lac de St R√©my</option>
  <option value="Beaucet ST Gens">Beaucet ST Gens</option>
  <option value="Bedoin, les 5 bergeries">Bedoin, les 5 bergeries</option>
  <option value="Bedoin, les 9 bergeries">Bedoin, les 9 bergeries</option>
  <option value="Bergerie de l'avocat">Bergerie de l'avocat</option>
  <option value="Bergeries sur les hauteurs de Villes-sur-Auzon;">Bergeries sur les hauteurs de Villes-sur-Auzon;</option>
  <option value="B√©rigoule Est">B√©rigoule Est</option>
  <option value="B√©rigoule Ouest">B√©rigoule Ouest</option>
  <option value="Bois de St Martin. D√©part : Le Garn 07">Bois de St Martin. D√©part : Le Garn 07</option>
  <option value="Bonnieux  -  Cadouc√®s">Bonnieux  -  Cadouc√®s</option>
  <option value="Borie de Clapeyrouse √† Saumane">Borie de Clapeyrouse √† Saumane</option>
  <option value="Boucle autour de Cairanne">Boucle autour de Cairanne</option>
  <option value="Brame du Cerf dans le Ventoux">Brame du Cerf dans le Ventoux</option>
  <option value="Buis les Baronnies - la Nible">Buis les Baronnies la Nible</option>
  <option value="Buoux Fort et Pelat">Buoux Fort et Pelat</option>
  <option value="Buoux, le rocher perc√©">Buoux, le rocher perc√©</option>
  <option value="Cabane du mouflon - Savoillan">Cabane du mouflon - Savoillan</option>
  <option value="Cabane du garde">Cabane du garde</option>
  <option value="Cabrieres  d'Avignon - La for√™t de c√®dres - abbaye de S√©nanque">Cabrieres  d'Avignon , La for√™t de c√®dres , abbaye de S√©nanque</option>
  <option value="Caisses JeanJean">Caisses JeanJean</option>
  <option value="Capelle et Masmol√®ne">Capelle et Masmol√®ne</option>
  <option value="Capitelles et castillones Aramon (30)">Capitelles et castillones Aramon (30)</option>
  <option value="Capitelles Moulin de Carri√®re Uz√®s">Capitelles Moulin de Carri√®re Uz√®s</option>
  <option value="Caroux">Caroux</option>
  <option value="Cascades de Sautadet">Cascades de Sautadet</option>
  <option value="Castillon du Gard">Castillon du Gard</option>
  <option value="Chapelle de la Sainte Baume, la Montagne et la Plaine de Sabran">Chapelle de la Sainte Baume, la Montagne et la Plaine de Sabran</option>
  <option value="Cirque des walkyries Marseille">Cirque des walkyries Marseille</option>
  <option value="Clansayes (26)">Clansayes (26)</option>
  <option value="Cluyer et les Aiguiers, d√©part de Saint Saturnin d'Apt">Cluyer et les Aiguiers, d√©part de Saint Saturnin d'Apt</option>
  <option value="Collias par le vire des Ch√®vres">Collias par le vire des Ch√®vres</option>
  <option value="Combe de Lioux">Combe de Lioux</option>
  <option value="Combe Obscure et du Chat">Combe Obscure et du Chat</option>
  <option value="Comps">Comps</option>
  <option value="Vallon de Combres">Vallon de Combres</option>
  <option value="Concluses de Lussan">Concluses de Lussan</option>
  <option value="C√¥te bleue au d√©part de Port Mejean">C√¥te bleue au d√©part de Port Mejean</option>
  <option value="Cr√™te du Grand Luberon au d√©part de Vaugines">Cr√™te du Grand Luberon au d√©part de Vaugines</option>
  <option value="Cr√™tes Arfuyen et le Saint Amand, Crestet">Cr√™tes Arfuyen et le Saint Amand, Crestet</option>
  <option value="Cr√™tes d‚ÄôArfuyen et Saint Amand,d√©part du col de la cha√Æne Dentelles de Montmirail">Cr√™tes d‚ÄôArfuyen et Saint Amand d√©part du col de la cha√Æne Dentelles de Montmirail</option>
  <option value="Cr√™tes de Romanin par le mont Gaussier.">Cr√™tes de Romanin par le mont Gaussier.</option>
  <option value="Cr√™tes des Alpilles">Cr√™tes des Alpilles</option>
  <option value="Cr√™tes du Barroux">Cr√™tes du Barroux</option>
  <option value="Cr√™tes du Ventoux">Cr√™tes du Ventoux</option>
  <option value="Cucuron Mourre N√®gre">Cucuron Mourre N√®gre</option>
  <option value="De Collias √Ä Sainte Veredeme">De Collias √Ä Sainte Veredeme</option>
  <option value="Dentelles sarrasines et clapis">Dentelles sarrasines et clapis</option>
  <option value="D√©part Beaumes-de-Venise">D√©part Beaumes-de-Venise</option>
  <option value="D√©part Saignon">D√©part Saignon</option>
  <option value="Tour des Dentelles">Tour des Dentelles</option>
  <option value="Estezargues (30)">Estezargues (30)</option>
  <option value="Eygali√®res boucle par les vallons">Eygali√®res boucle par les vallons</option>
  <option value="Eygalieres petit et gros Calans">Eygalieres petit et gros Calans</option>
  <option value="Eygali√®res, tour de la baume Brignolle">Eygali√®res, tour de la baume Brignolle</option>
  <option value="Eygi√®res Aureille">Eygi√®res Aureille</option>
  <option value="Falaise de Lioux">Falaise de Lioux</option>
  <option value="Falaises et gorges du Gardon au d√©part de Collias">Falaises et gorges du Gardon au d√©part de Collias</option>
  <option value="Fond de l'Orme, M√©rindol">Fond de l'Orme, M√©rindol</option>
  <option value="Fontaine de Vaucluse">Fontaine de Vaucluse</option>
  <option value="For√™t des cedres La Coste">For√™t des cedres La Coste</option>
  <option value="For√™t domaniale Sault Col Abeilles">For√™t domaniale Sault Col Abeilles</option>
  <option value="Garde Grosse Ch√¢teauneuf de Bordette">Garde Grosse Ch√¢teauneuf de Bordette</option>
  <option value="Gardon rive droite, Chapelle l'Ermitage">Gardon rive droite, Chapelle l'Ermitage</option>
  <option value="Gorges d‚Äô Oppedette, abbaye de Valsainte, saut du moine">Gorges d‚Äô Oppedette, abbaye de Valsainte, saut du moine</option>
  <option value="Goult lumieres">Goult lumieres</option>
  <option value="Grand barbeirol au d√©part de Crillon le Brave">Grand barbeirol au d√©part de Crillon le Brave</option>
  <option value="Guidon du Bouquet (30)">Guidon du Bouquet (30)</option>
  <option value="Hameaux ruin√©s de Tarlan et Poitevin">Hameaux ruin√©s de Tarlan et Poitevin</option>
  <option value="Hauts de Gordes">Hauts de Gordes</option>
  <option value="Hivernale dans le Ventoux - entre face sud et face nord">Hivernale dans le Ventoux - entre face sud et face nord</option>
  <option value="Ile de la Barthelasse">Ile de la Barthelasse</option>
  <option value="Lacoste">Lacoste</option>
  <option value="Lacoste chapelle St V√©ran, abbaye de St Hilaire">Lacoste chapelle St V√©ran, abbaye de St Hilaire</option>
  <option value="Lafare">Lafare</option>
  <option value="Lagnes">Lagnes</option>
  <option value="Lagnes, Fontaine de Vaucluse par l'aqueduc">Lagnes, Fontaine de Vaucluse par  l'aqueduc</option>
  <option value="Lagon bleu Maussane">Lagon bleu Maussane</option>
  <option value="Maussane">Maussane</option>
  <option value="Lamanon Roquemartine">Lamanon Roquemartine</option>
  <option value="Lance face Nord">Lance face Nord</option>
  <option value="Lance par le rocher des aures">Lance par le rocher des aures</option>
  <option value="Lauris">Lauris</option>
  <option value="Lauris Cap de Serre (84)">Lauris Cap de Serre (84)</option>
  <option value="Lioux, les falaises de la Madeleine">Lioux, les falaises de la Madeleine</option>
  <option value="Luberon sud, le Bastidon du Roumiguier">Luberon sud, le Bastidon du Roumiguier</option>
  <option value="Luberon, la Baume Martin">Luberon, la Baume Martin</option>
  <option value="Malauc√®ne, le Barroux">Malauc√®ne, le Barroux</option>
  <option value="Malemort du Comtat - La combe du diable">Malemort du Comtat - La combe du diable</option>
  <option value="Marseilleveyre">Marseilleveyre</option>
  <option value="Massif du Barry">Massif du Barry</option>
  <option value="Matemale Pyr√©n√©es">Matemale Pyr√©n√©es</option>
  <option value="Mayorque gorges de la peine">Mayorque gorges de la peine</option>
  <option value="Mejanne le Clap L'aven Peyre Haute">Mejanne le Clap L'aven Peyre Haute</option>
  <option value="Merindol la vall√©e du D√©goutau">Merindol la vall√©e du D√©goutau</option>
  <option value="Mollans sur Ouv√®ze Pierrelongue">Mollans sur Ouv√®ze Pierrelongue</option>
  <option value="Monieux, gorges de la Nesque">Monieux, gorges de la Nesque</option>
  <option value="Mont Puget ">Mont Puget </option>
  <option value="Montagne de Linceuil (26)">Montagne de Linceuil (26)</option>
  <option value="Montagne de Mi√©landre">Montagne de Mi√©landre</option>
  <option value="La montagne de Bluye D√©part de St L√©ger">La montagne de Bluye D√©part de St L√©ger</option>
  <option value="Monts de Vaucluse Marignon">Monts de Vaucluse Marignon</option>
  <option value="Mont Ventoux Chalet Reynard">Monts Ventoux Chalet Reynard </option>
  <option value="Mornas (84)">Mornas (84)</option>
  <option value="Moulin de Javon et les baumes de Eymians et de Roustan">Moulin de Javon et les baumes de Eymians et de Roustan</option>
  <option value="Mourre N√®gre">Mourre N√®gre</option>
  <option value="Mourre N√®gre par Auribeau">Mourre N√®gre par Auribeau</option>
  <option value="Mourre n√®gre par Cucuron">Mourre n√®gre par Cucuron</option>
  <option value="Mourre N√®gre par Regain et la femme morte, Luberon (Nord)">Mourre N√®gre par Regain et la femme morte, Luberon (Nord)</option>
  <option value="Murs">Murs</option>
  <option value="Nible Buis les Baronnies">Nible Buis les Baronnies</option>
  <option value="Notre dame des neiges, la gacholle">Notre dame des neiges, la gacholle</option>
  <option value="Ocres de Mormoiron">Ocres de Mormoiron</option>
  <option value="Oppidum La garde d'Apt">Oppidum La garde d'Apt</option>
  <option value="Orgon">Orgon</option>
  <option value="Pas de la Frache">Pas de la Frache</option>
  <option value="Pays d'Apt, Caseneuve, Colorado">Pays d'Apt, Caseneuve, Colorado</option>
  <option value="Petit et gros Calan">Petit et gros Calan</option>
  <option value="Pic de Bertagne">Pic de Bertagne</option>
  <option value="Pic de Bertagne G√©menos">Pic de Bertagne G√©menos</option>
  <option value="Pic de Faiendre">Pic de Faiendre</option>
  <option value="Pic des Mouches au d√©part de Puyloubier">Pic des Mouches au d√©part de Puyloubier</option>
  <option value="Pigeonnier. D√©part : Eygui√®res">Pigeonnier. D√©part : Eygui√®res</option>
  <option value="Plateau d‚Äô Orgon, chapelle de Beauregard">Plateau d‚Äô Orgon, chapelle de Beauregard</option>
  <option value="Plateau de Lacau et le camp de C√©sar">Plateau de Lacau et le camp de C√©sar</option>
  <option value="Pont du gard">Pont du gard</option>
  <option value="Portalas -  M√©nerbes">Portalas -  M√©nerbes</option>
  <option value="Portalas depuis BONNIEUX">Portalas depuis BONNIEUX</option>
  <option value="Promenade autour des Baux">Promenade autour des Baux</option>
  <option value="Ramayettes au d√©part de B√©doin">Ramayettes au d√©part de B√©doin</option>
  <option value="Rando d‚ÄôEyguieres √† Lamanon par le D√©fens">Rando d‚ÄôEyguieres √† Lamanon par le D√©fens</option>
  <option value="Rando Gourmande">Rando Gourmande</option>
  <option value="Raquettes √† Forgeassoud">Raquettes √† Forgeassoud</option>
  <option value="Raquettes Matemale">Raquettes Matemale</option>
  <option value="Raquettes Montclar">Raquettes Montclar</option>
  <option value="Regalon , t√™tes des Buisses, gorge du Regalon">Regalon , t√™tes des Buisses, gorge du Regalon</option>
  <option value="Reilhanette">Reilhanette</option>
  <option value="Roche sur le Buis">Roche sur le Buis</option>
  <option value="Rochers de la Madeleine et les ocres de Bedoin">Rochers de la Madeleine et les ocres de Bedoin</option>
  <option value="Roque D'Anth√©ron Chemin Cr√™tes">Roque D'Anth√©ron Chemin Cr√™tes</option>
  <option value="Russan - pont Saint Nicolas gorges du Gardon">Russan - pont Saint Nicolas gorges du Gardon</option>
  <option value="Saint Andre d'Oleargues">Saint Andre d'Oleargues</option>
  <option value="Saint Etienne du Gr√®s Notre dame du chateau">Saint Etienne du Gr√®s Notre dame du chateau</option>
  <option value="Saint Gens Combe de Capellan">Saint Gens Combe de Capellan</option>
  <option value="Saint Hubert au d√©part du lac de Monieux">Saint Hubert au d√©part du lac de Monieux</option>
  <option value="Saint Victor la Coste">Saint Victor la Coste</option>
  <option value="Sainte Victoire par le sentier des Plaideurs">Sainte Victoire par le sentier des Plaideurs</option>
  <option value="Sainte Victoire versant Sud, Les Clapiers">Sainte Victoire versant Sud, Les Clapiers</option>
  <option value="Sainte-Victoire">Sainte-Victoire</option>
  <option value="Sainte-Victoire versant Nord par le sentier des Plaideurs">Sainte-Victoire versant Nord par le sentier des Plaideurs</option>
  <option value="S√©guret : collines et vignobles">S√©guret : collines et vignobles</option>
  <option value="S√©jour Ard√®che La bombine">S√©jour Ard√®che La bombine</option>
  <option value="Sentier des baliseurs dans les Alpilles">Sentier des baliseurs dans les Alpilles</option>
  <option value="Simiane La Rotonde">Simiane La Rotonde</option>
  <option value="Sivergues: le vallon de Petarelle, la cr√™te et le d√©fil√© du rocher">Sivergues: le vallon de Petarelle, la cr√™te et le d√©fil√© du rocher</option>
  <option value="Sommet des Fourcats, d√©part Robion">Sommet des Fourcats, d√©part Robion</option>
  <option value="Source Aramon">Source Aramon</option>
  <option value="St Gens et la combe de Capellan">St Gens et la combe de Capellan</option>
  <option value="St Saturnin les Apt - Le sentier des Aiguiers par le Cluyer">St Saturnin les Apt - Le sentier des Aiguiers par le Cluyer</option>
  <option value="Tallagard et le vieux vernegues.">Tallagard et le vieux vernegues.</option>
  <option value="Teyssi√®res, le Cougoir">Teyssi√®res, le Cougoir</option>
  <option value="Theziers Gard Land's (30)">Theziers Gard Land's (30)</option>
  <option value="Tour des √©tangs">Tour des √©tangs</option>
  <option value="Tour des Opies retour par Civadiers">Tour des Opies retour par Civadiers</option>
  <option value="Tour du guet (Aureille) les Civadi√®res">Tour du guet (Aureille) les Civadi√®res</option>
  <option value="Tour Philipe">Tour Philipe</option>
  <option value="Trou du furet et montagne du Serre (Drome )">Trou du furet et montagne du Serre (Drome )</option>
  <option value="Vaison la romaine le Crestet">Vaison la romaine le Crestet</option>
  <option value="Vall√©e de l'Eure (Uzes)">Vall√©e de l'Eure (Uzes)</option>
  <option value="Vallon de l'aiguille, la for√™t de c√®dre">Vallon de l'aiguille, la for√™t de c√®dre</option>
  <option value="Vallon des amants (Alpilles)">Vallon des amants (Alpilles)</option>
  <option value="Vallons et cr√®tes autour du Barroux">Vallons et cr√®tes autour du Barroux</option>
  <option value="Vaumalle: V√©roncle √† Joucas">Vaumalle: V√©roncle √† Joucas</option>
  <option value="Venasque la combe de Capellan">Venasque la combe de Capellan</option>
  <option value="Ventabren">Ventabren</option>
  <option value="Ventouret">Ventouret</option>
  <option value="Mont Ventoux, les Abeilles">Ventoux, les Abeilles</option>
  <option value="Mont Ventoux, pavillon Rolland">Ventoux, pavillon Rolland</option>
  <option value="Viens, hameaux et chapelles">Viens, hameaux et chapelles</option>
  <option value="Village des Bories, Senancole, Senanque, vallon grande combe">Village des Bories, Senancole, Senanque, vallon grande combe</option>
  <option value="Villages des dentelles au d√©part de Lafare">Villages des dentelles au d√©part de Lafare</option>
  <option value="Ville/Auzon combe des Escampeaux, bergerie">Ville/Auzon combe des Escampeaux, bergerie</option>
  <option value="Le chemin des Indochinois">Le chemin des Indochinois</option>
  <option value="autre">Autre‚Ä¶ (saisir manuellement)</option>

  
  <!-- si tu veux toutes les options, r√©ins√®re ta liste compl√®te ici -->
</select>

<input id="autreNomRando" placeholder="Saisir le nom de la randonn√©e" style="display:none;width:100%;font-weight:bold;margin-top:6px">

<hr>
<label for="date">Date de la randonn√©e :</label>
<input type="date" id="date" onchange="afficherJour()">
<label>Jour de la semaine : <span id="jour-semaine"></span></label>

<hr>
<h2>Parkings</h2>
<label for="lieu">Parking Covoiturage (modifiable)</label>
<select id="lieu" onchange="gererAutreLieu(); setHomeFromParking();" style="font-weight: bold;">
  <option value="" selected="" hidden="">Choisir un parking</option>
  <option value="Parking Bricomarch√© - Ch√¢teaurenard">Parking Bricomarch√© - Ch√¢teaurenard</option>
  <option value="Parking MIN - Ch√¢teaurenard">Parking MIN - Ch√¢teaurenard</option>
  <option value="Parking du Stade - Ch√¢teaurenard">Parking du Stade - Ch√¢teaurenard</option>
  <option value="Parking Super U - Ch√¢teaurenard">Parking Super U - Ch√¢teaurenard</option>
    <option value="Parking des All√©es - Ch√¢teaurenard">Parking des All√©es - Ch√¢teaurenard</option>
  <option value="autre">Autre... (saisir manuellement)</option>
</select>
<input type="text" id="autreLieu" maxlength="100" placeholder="Entrez un autre parking" style="display:none; margin-top:0.5rem; color:red; font-weight:bold;">

<div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;margin-top:10px;">
  <label for="heure-rv">Heure de rendez-vous (hh:mm) :</label>
  <input type="time" id="heure-rv" onchange="calculerHeureDepart()">
  <label><strong>Heure de d√©part pr√©vue : <span id="heure-depart"></span></strong></label>
</div>

<label for="description">Trajet sugg√©r√© :</label>
<textarea id="description" rows="2" maxlength="1000"></textarea>

<label for="parking-depart" class="small-label">Parking de d√©part Randonn√©e : (Tapez les 4 premi√®res lettres : chalet, col, parking, nom de village... et d√©partement si homonynie, le retour du serveur n'est pas instantan√© ! Et ajustez, √©ventuellement le parking avec votre souris sur la carte)</label>

<input type="text" id="parking-depart" list="parkings-list" placeholder="Parking d√©part randonn√©e" autocomplete="off">

<datalist id="parkings-list"></datalist>


<button type="button" onclick="updateParkingMap()">Afficher le parking et la meteo sous la carte </button>

<!-- La carte appara√Ætra ici + bouton recentrer trajet -->
<div id="parkingMap" style="display:none; margin-top:15px; width:100%; height:400px; border-radius:10px; overflow:hidden;"></div>
<!-- Bouton Recentrer : utilisation d'onclick pour fiabilit√© -->
<button type="button" id="btn-recentrer-trajet" style="display:none; margin-top:10px;" onclick="recenterRoute()">
  üìç Recentrer sur le trajet
</button>

<!-- ‚úÖ M√âT√âO OPEN-METEO -->
<h2>üå¶Ô∏è M√©t√©o au parking de d√©part - pr√©visions √† 7 jours </h2>
<h5> Donn√©es meteo open source : https://open-meteo.com/ </h5>
<h5>Si le jour de rando est inclus dans l'intervalle, les pr√©visions seront surlign√©es en jaune, la pr√©vision du jour de rando est directement int√©gr√©e dans la Feuille de Route</h5><h5>
<div id="meteo-openmeteo" style="display:none;margin-top:15px;padding:12px;border-radius:10px;background:#eef7f7;">
  <div id="meteo-current"></div>
  <div id="meteo-forecast"></div>
</div>

<hr>
</h5><h2>Co√ªts</h2>
<div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;">
  <label for="trajet-km">Trajet en km :</label>
  <input type="number" id="trajet-km" oninput="calculerCouts()">
  <label for="cout-autoroute">Co√ªt de l'autoroute (‚Ç¨) :</label>
  <input type="number" id="cout-autoroute" oninput="calculerCouts()">
</div>
<p><strong>Total trajet : <span id="total-trajet">0</span> ‚Ç¨</strong></p>
<p>Co√ªt total : <span id="cout-total">0</span> ‚Ç¨</p>
<p>Co√ªt covoiturage (par 4) : <span id="covoit4">0</span> ‚Ç¨</p>
<p>Co√ªt covoiturage (par 5) : <span id="covoit5">0</span> ‚Ç¨</p>

<hr>
<h2>Informations techniques</h2>
<style>
  /* Conteneur g√©n√©ral du formulaire */
  .form-wrapper {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
  }

  /* Blocs rando (distance, d√©nivel√©, dur√©e) */
  .bloc-form {
    margin-bottom: 1.2rem;
    text-align: center;
  }

  .bloc-form label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.3rem;
  }

  .bloc-form input {
    display: block;
    margin: 0.4rem auto 0 auto;
    width: 70%;
    min-width: 110px;
    padding: 6px 8px;
    font-size: 1rem;
    border-radius: 6px;
  }

  /* Couleurs sp√©cifiques */
  .bloc-distance label, .bloc-distance input {
    color: #1b8a2f;
    border: 2px solid #1b8a2f;
    font-weight: bold;
  }

  .bloc-denivele label, .bloc-denivele input {
    color: #005bbb;
    border: 2px solid #005bbb;
    font-weight: bold;
  }

  .bloc-duree input, .bloc-duree input {
    border: 2px solid #555;
    font-weight: bold;
  }

  /* Blocs IBP / Technicit√© / Risque / Remarques */
  .bloc-champ {
    margin-bottom: 1.2rem;
    text-align: center;
    font-weight: bold;
  }

  .bloc-champ label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.3rem;
  }

  .bloc-champ input,
  .bloc-champ textarea {
    display: block;
    width: 80%;
    max-width: 350px;
    margin: 0.3rem auto;
    padding: 6px 8px;
    border-radius: 6px;
    border: 2px solid #555;
    font-size: 1rem;
  }

  .message-erreur {
    color: red;
    font-size: 0.9rem;
    display: none;
    margin-top: 0.3rem;
  }

  /* Paragraphes suivants (mise en page normale) */
  .contenu-normal {
    text-align: left;
    margin: 1rem auto;
    max-width: 700px; /* largeur confortable sur desktop */
  }

  .contenu-normal p {
    margin-bottom: 1rem;
  }
  .meteo-rando-day {
  background: #fff3cd;
  border-left: 5px solid #f0ad4e;
  padding: 6px;
  border-radius: 6px;
}
#profil-altimetrique {
  width: 100%;
  max-width: 100%;
}

#elevationChart {
  width: 100% !important;
  height: 35vh !important;   /* MOBILE */
  max-height: 260px;
}

@media (min-width: 768px) {
  #elevationChart {
    height: 320px !important; /* DESKTOP */
  }
}
.slope-legend {
  display:flex;
  align-items:center;
  gap:8px;
  font-size:0.9rem;
  margin-top:8px;
}

.slope-legend .gradient {
  width:140px;
  height:10px;
  border-radius:6px;
  background:linear-gradient(to right, orange, red);
}


</style>

<!-- === IMPORT GPX & CALCUL IBP === -->
<div class="bloc-champ" style="margin-bottom:2rem;">
  <label class="small-label" style="display:block; text-align:left;">
  Importer un fichier GPX ‚Äì L‚Äôanalyse fournit : Distance, D√©nivel√© +,
  Dur√©e (si disponible) et IBP (HKG). La cr√©ation du profil est automatique,
  vous pourrez joindre la courbe cr√©√©e (fichier jpg) en PJ au mail.
</label>

  <form enctype="multipart/form-data" id="formuploadajax">
    
    <input type="file" id="file" name="file" accept=".gpx" required>
    <br><br>
    <button type="submit">Analyser le fichier GPX</button>
  </form>

  <p id="gpx-status" style="font-weight:bold;margin-top:8px;"></p>
</div>
<!-- === FIN IMPORT GPX === -->


<!-- FORMULAIRE -->
<div class="form-wrapper">

  <div class="bloc-form bloc-distance">
    <label for="km">Distance de la randonn√©e - marche (km) :</label>
    <input type="number" id="km" onchange="verifierInfos(); ajusterLargeur(this);" oninput="verifierInfos(); ajusterLargeur(this);">
  </div>

  <div class="bloc-form bloc-denivele">
    <label for="denivele">D√©nivel√© (m√®tres) :</label>
    <input type="number" id="denivele" onchange="verifierInfos(); ajusterLargeur(this);" oninput="verifierInfos(); ajusterLargeur(this);">
  </div>

  <div class="bloc-form bloc-duree">
    <label for="duree">Dur√©e totale (hh:mm) :</label>
    <input type="text" id="duree" placeholder="hh:mm">
  </div>

</div>
<!-- FIN km rando denivele et duree -->

<div class="bloc-champ">
  <label for="ibp">IBP (HKG) :</label>
  <input type="number" id="ibp" oninput="afficherIBP()">
  <p><strong>Effort (IBP) : <span id="effort">‚ùå IBP non renseign√©</span></strong></p>
</div>

<div class="bloc-champ">
  <label for="technicite">Technicit√© (1-5) :</label>
  <input type="number" id="technicite" oninput="validerChamp('technicite'); afficherDifficulte('technicite','technicite-label');" min="1" max="5">
  <p><strong>Technicit√© : <span id="technicite-label">‚ùå Non renseign√©</span></strong></p>
  <p id="technicite-erreur" class="message-erreur">Veuillez entrer une valeur entre 1 et 5.</p>
</div>

<div class="bloc-champ">
  <label for="risque">Risque (1-5) :</label>
  <input type="number" id="risque" oninput="validerChamp('risque'); afficherRisque('risque','risque-label');" min="1" max="5">
  <p><strong>Risque : <span id="risque-label">‚ùå Non renseign√©</span></strong></p>
  <p id="risque-erreur" class="message-erreur">Veuillez entrer une valeur entre 1 et 5.</p>
</div>

<div class="contenu-normal">
  <label for="remarques">Remarques &amp; particularit√©s :</label>
  <textarea id="remarques" rows="4" maxlength="2000"></textarea>
</div>
<div id="profil-altimetrique" style="width:100%; max-width:100%;">
  <canvas id="elevationChart"></canvas>
</div>
  <!-- ‚¨áÔ∏è ICI : juste sous le profil -->
  <button id="exportProfilJPG">
    Exporter le profil altim√©trique (JPG)
  </button>
</div>
<div class="slope-legend">
  <span> Pentes + : 0 %</span>
  <div class="gradient"></div>
  <span>‚â• 20 %</span>
</div>


 <!-- fin mise en page  km rando denivele et duree -->

<!-- PARAGRAPHES SUIVANTS AVEC MISE EN PAGE NORMALE -->
<!-- <div class="contenu-normal">
  <p>Voici un paragraphe normal apr√®s le formulaire. Il est align√© √† gauche et n‚Äôest pas affect√© par le centrage du formulaire.</p>
  <p>Un autre paragraphe, √©galement √† gauche, avec son espacement naturel.</p>
</div> -->

<hr>
<h2 style="color:black;">Organisateur</h2>
<label for="organisateur">Choisissez un organisateur :</label>
<select id="organisateur" onchange="afficherOrganisateur()" style="font-size:15px;padding:6px;height:34px;line-height:20px;border-radius:6px;">
  <option value="">-- S√©lectionnez --</option>
  <option value="Pierre Camille ALEZINA 06 03 18 76 16">ALEZINA Pierre Camille  06 03 18 76 16</option>
  <option value="Dominique BIZARD 06 88 00 15 85">BIZARD Dominique 06 88 00 15 85</option>
  <option value="Andr√© BRIOUDE 06 84 53 70 30">BRIOUDE Andr√© 06 84 53 70 30</option>
  <option value="Nadine BRUN 06 82 48 72 61">BRUN Nadine 6 82 48 72 61</option>
  <option value="ChristianCIBRARIO 07 81 69 66 16">CIBRARIO Christian 07 81 69 66 16</option>
  <option value="Roland DUPR√â 06 52 88 26 57">DUPR√â Roland 06 52 88 26 57</option>
  <option value="Marie-Ange DUVERNE 06 29 12 33 65">DUVERNE Marie-Ange 06 29 12 33 65</option>
  <option value="Sylvie ELISSALDE 06 77 91 03 61">ELISSALDE Sylvie 06 77 91 03 61</option>
  <option value="Henri FABRE 06 09 89 02 67">FABRE Henri 06 09 89 02 67</option>
  <option value="Brigitte GRANDPERRIN 06 24 75 90 59">GRANDPERRIN Brigitte 06 24 75 90 59</option>
  <option value="Bernard GRANGE 06 21 56 59 70"> GRANGE Bernard 06 21 56 59 70</option>
  <option value="Jean-Luc HERV√â 07 68 60 38 59">HERV√â Jean-Luc 07 68 60 38 59</option>
  <option value="Bernadette JOUVE 06 74 49 96 90">JOUVE Bernadette 06 74 49 96 90</option>
  <option value="Pierre MARTIN 06 08 23 62 85">MARTIN Pierre 06 08 23 62 85</option>
  <option value="Annick NOUGUIER 06 87 39 93 86">NOUGUIER Annick 06 87 39 93 86</option>
  <option value="Michel PALLIER 06 87 92 53 80"> PALLIER Michel 06 87 92 53 80</option>
  <option value="Marianne POMMER 06 62 17 63 49">POMMER Marianne 06 62 17 63 49</option>
  <option value="Yves RAOULX 07 66 59 74 00">RAOULX Yves 07 66 59 74 00</option>
  <option value="Didier RAYNAL 06 80 94 09 42">RAYNAL Didier 06 80 94 09 42</option>
  <option value="Jean-Louis REYNIER 06 13 09 29 14">REYNIER Jean-Louis 06 13 09 29 14</option>
  <option value="Catherine TAUSSIG 06 20 42 54 33">TAUSSIG Catherine 06 20 42 54 33</option>
  <option value="Jean-Claude VALDARCHI 06 25 70 49 05">VALDARCHI Jean-Claude 06 25 70 49 05</option>
  <option value="TEST 06 01 02 03 04">TEST 06 01 02 03 04</option>
  <!-- Ajoute la liste compl√®te si besoin -->
</select>
<p>Organisateur : <span id="organisateur-label">‚ùå Non renseign√©</span></p>

<hr>
<!-- Bouton unique -->
<button id="btn-generer" type="button">1-G√©n√©rer le r√©sum√©</button>
<br><br>
<span style="color:red; font-weight:bold;">EN CLIQUANT SUR ENVOI, LE MAIL (AVEC LA COURBE EN PJ) PART IMM√âDIATEMENT, BIEN V√âRIFIER VOTRE R√âSUM√â, VOTRE MESSAGERIE N'EST PAS UTILIS√âE, MERCI</span>
<br><br>
<button type="button" onclick="envoyerEmail()">2-Envoyer automatiquement</button>
<br><br>
<!-- <span style="color:red; font-weight:bold;">WINDOWS/ANDROID - UTILISEZ LES TOUCHES Ctrl-V POUR COLLER LE R√âSUM√â DANS UN NOUVEL EMAIL</span>
<br><br>
<button type="button" onclick="envoyerEmail()">2(variante)-Coller (Ctrl-V) le r√©sum√© dans votre messagerie Windows/Android</button> -->

<div id="resultat" aria-live="polite"></div>
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>


<!-- Script unique et ordonn√© -->
<script>
  window.meteoJourRando = null;

  function getDateRando(){
  const el = document.getElementById("date");
  if(!el || !el.value) return null;
  return el.value.slice(0, 10); // YYYY-MM-DD
}
function normalizeDate(d){
  if(!d) return null;
  return d.toString().slice(0, 10); // YYYY-MM-DD
}


/* --- Recherche rando (autocompl√©tion l√©g√®re) --- */
const selectBackup = document.getElementById('nom');
const baseOptions = Array.from(selectBackup.options).map(o => ({value: o.value, text: o.text}));
const recherche = document.getElementById('rechercheRando');
const resultsList = document.getElementById('resultsList');
const champAutre = document.getElementById('autreNomRando');

function normalize(s){ return (s||'').normalize ? s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase() : (s||'').toLowerCase(); }

function renderList(items, highlightIndex=-1){
  resultsList.innerHTML = '';
  if(items.length===0){
    const li=document.createElement('li'); li.className='no-results'; li.textContent='Aucun r√©sultat'; resultsList.appendChild(li);
  } else {
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.setAttribute('role','option'); li.dataset.value=it.value; li.textContent=it.text;
      if(idx===highlightIndex) li.setAttribute('aria-selected','true');
      resultsList.appendChild(li);
    });
  }
  const aut = baseOptions.find(o=>o.value==='autre');
  if(aut){ const li=document.createElement('li'); li.setAttribute('role','option'); li.dataset.value=aut.value; li.textContent=aut.text; resultsList.appendChild(li); }
  resultsList.style.display='block';
  recherche.setAttribute('aria-expanded','true');
}
function hideList(){ resultsList.style.display='none'; recherche.setAttribute('aria-expanded','false'); clearHighlight(); }
function resetAll(){ hideList(); champAutre.style.display='none'; champAutre.value=''; }

recherche.addEventListener('input', ()=>{
  const q=recherche.value.trim();
  if(q.length===0){ resetAll(); return; }
  const qn=normalize(q);
  const found = baseOptions.filter(o=>o.value && o.value!=='autre').filter(o=>normalize(o.text).includes(qn));
  renderList(found);
});

function chooseItem(value, text){
  if(value==='autre'){ champAutre.style.display='block'; champAutre.value=''; champAutre.focus(); recherche.value=''; }
  else { recherche.value = text; }
  hideList();
  try{ selectBackup.value = value; }catch(e){}
}

resultsList.addEventListener('click',(ev)=>{ const li=ev.target.closest('li[role="option"]'); if(!li) return; chooseItem(li.dataset.value, li.textContent); });
resultsList.addEventListener('touchstart',(ev)=>{ const li=ev.target.closest('li[role="option"]'); if(!li) return; ev.preventDefault(); chooseItem(li.dataset.value, li.textContent); },{passive:false});

let highlight = -1;
function clearHighlight(){ highlight=-1; Array.from(resultsList.querySelectorAll('li[role="option"]')).forEach(li=>li.removeAttribute('aria-selected')); }
function updateHighlight(delta){ const items=Array.from(resultsList.querySelectorAll('li[role="option"]')); if(items.length===0) return; highlight = Math.max(0,Math.min(items.length-1, highlight+delta)); items.forEach((li,i)=>{ if(i===highlight){ li.setAttribute('aria-selected','true'); li.scrollIntoView({block:'nearest'}); } else li.removeAttribute('aria-selected'); }); }
recherche.addEventListener('keydown',(ev)=>{ if(resultsList.style.display==='none') return; if(ev.key==='ArrowDown'){ ev.preventDefault(); updateHighlight(+1); } else if(ev.key==='ArrowUp'){ ev.preventDefault(); updateHighlight(-1); } else if(ev.key==='Enter'){ ev.preventDefault(); const items=Array.from(resultsList.querySelectorAll('li[role="option"]')); if(items[highlight]) chooseItem(items[highlight].dataset.value, items[highlight].textContent); } else if(ev.key==='Escape'){ hideList(); } });
document.addEventListener('click',(ev)=>{ if(!ev.target.closest('.dropdown-wrap') && ev.target !== champAutre) hideList(); });

/* --- divers utilitaires d'affichage --- */
function afficherJour(){
  const date = document.getElementById("date").value;
  if(date){ const jour = new Date(date).toLocaleDateString('fr-FR',{weekday:'long'}); document.getElementById("jour-semaine").textContent = jour.charAt(0).toUpperCase()+jour.slice(1); }
}
function calculerHeureDepart(){
  const h=document.getElementById("heure-rv").value;
  if(h){ const [hours,minutes]=h.split(':').map(Number); const d=new Date(); d.setHours(hours, minutes+15); document.getElementById("heure-depart").textContent = d.toTimeString().substring(0,5); }
}
function calculerCouts(){
  const km=parseFloat(document.getElementById("trajet-km").value) || 0;
  const autoroute=parseFloat(document.getElementById("cout-autoroute").value) || 0;
  const totalTrajet = km * 0.3;
  const coutTotal = totalTrajet + autoroute;
  document.getElementById("total-trajet").textContent = totalTrajet.toFixed(2);
  document.getElementById("cout-total").textContent = coutTotal.toFixed(2);
  document.getElementById("covoit4").textContent = (coutTotal/4).toFixed(2);
  document.getElementById("covoit5").textContent = (coutTotal/5).toFixed(2);
}
function afficherIBP(){
  const ibp = parseInt(document.getElementById("ibp").value) || 0;
  const effort = document.getElementById("effort");
  if(ibp < 25) effort.textContent = "üü¢ 1 (Facile)";
  else if(ibp <= 50) effort.textContent = "üîµ 2 (Assez Facile)";
  else if(ibp <= 75) effort.textContent = "üü† 3 (Peu Difficile)";
  else if(ibp <= 100) effort.textContent = "üî¥ 4 (Assez Difficile)";
  else effort.textContent = "‚ö´Ô∏è 5 ( üòÖ Difficile)";
}
function afficherDifficulte(id,label){ const niveaux=["Facile","Assez Facile","Peu Difficile","Assez Difficile","Difficile"]; const v=document.getElementById(id).value; document.getElementById(label).textContent = niveaux[v-1] || "Non renseign√©"; }
function afficherRisque(id,label){ const niveaux=["Faible","Assez Faible","Peu √âlev√©","Assez √âlev√©","√âlev√©"]; const v=document.getElementById(id).value; document.getElementById(label).textContent = niveaux[v-1] || "Non renseign√©"; }
function afficherOrganisateur(){ const o=document.getElementById("organisateur").value; document.getElementById("organisateur-label").textContent = o || "Non renseign√©"; }
function gererAutreLieu(){ const s=document.getElementById('lieu'); const a=document.getElementById('autreLieu'); if(s.value==='autre'){ a.style.display='block'; a.focus(); } else { a.style.display='none'; a.value=''; } }

/* --- validation & UI helpers --- */
function ajusterLargeur(input){ const valeur = input.value ?? ""; const len = String(valeur).length; const minChars = 6; const maxChars = 18; const extra = 1; const target = Math.min(Math.max(len, minChars), maxChars) + extra; input.style.width = target + "ch"; }
function verifierInfos(){ const kmInput=document.getElementById('km'); const deniveleInput=document.getElementById('denivele'); const km=parseFloat(kmInput.value)||0; const denivele=parseFloat(deniveleInput.value)||0;
  if(km>0 && km<13) afficherBulle("Pas mal, mais vous pouvez mieux faire üòâ", kmInput);
  if(km>=13 && km<20) afficherBulle("c'est bien, tout le monde va adorer üòâ", kmInput);
  if(km>=20) afficherBulle("Trop fort, √™tes-vous s√ªr de terminer le parcours üòÇ?", kmInput);
  if(denivele>0 && denivele<500) afficherBulle("Encore un effort ü§™, allez !", deniveleInput);
  if(denivele>=500) afficherBulle("Vous allez atteindre des sommets üòÄ, bravo !", deniveleInput);
}
function afficherBulle(texte,cible){ const bulle=document.createElement('div'); bulle.textContent=texte; bulle.style.position='absolute'; bulle.style.background='#1a73e8'; bulle.style.color='white'; bulle.style.padding='6px 10px'; bulle.style.borderRadius='8px'; bulle.style.fontSize='0.9rem'; bulle.style.whiteSpace='nowrap'; bulle.style.boxShadow='0 2px 6px rgba(0,0,0,0.3)'; bulle.style.transition='opacity 0.5s'; bulle.style.opacity='1';
  const rect=cible.getBoundingClientRect(); const scrollY = window.scrollY || document.documentElement.scrollTop; bulle.style.left = (rect.left) + 'px'; bulle.style.top = (rect.top + scrollY - 35) + 'px'; bulle.style.zIndex=1000; document.body.appendChild(bulle);
  setTimeout(()=>{ bulle.style.opacity='0'; setTimeout(()=>bulle.remove(),500); },4000);
}

function validerChamp(id){ const champ=document.getElementById(id); const valeur=parseInt(champ.value,10); const messageErreurId=id+'-erreur'; let messageErreur=document.getElementById(messageErreurId); if(!messageErreur){ messageErreur=document.createElement('p'); messageErreur.id=messageErreurId; messageErreur.className='message-erreur'; messageErreur.style.color='white'; messageErreur.style.backgroundColor='red'; messageErreur.style.padding='5px'; messageErreur.style.borderRadius='3px'; messageErreur.style.fontSize='0.9em'; messageErreur.style.marginTop='5px'; champ.parentNode.insertBefore(messageErreur, champ.nextSibling); } if(isNaN(valeur) || valeur<1 || valeur>5){ messageErreur.textContent='Veuillez entrer une valeur entre 1 et 5.'; messageErreur.style.display='block'; } else messageErreur.style.display='none'; }

document.addEventListener('DOMContentLoaded', function(){
  // liaison bouton g√©n√©rer
  const btn = document.getElementById('btn-generer');
  if(btn){ btn.addEventListener('click', function(e){ e.preventDefault(); genererTexte(); }); }
  // liaison validation nombre
  ["trajet-km","cout-autoroute","km","denivele","ibp"].forEach(id=>{ const champ=document.getElementById(id); if(champ){ champ.addEventListener('input', ()=> validerNumerique(id)); }});
  // adapt width initial
  document.querySelectorAll("#km,#denivele").forEach(el=>ajusterLargeur(el));
});
function resizeCanvasToScreen() {
  const canvas = document.getElementById("elevationChart");
  if (!canvas) return;

  const container = canvas.parentElement;
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight || 300;
}
/* --- utilitaires pour le r√©sum√© --- */
function getNomRando(){ const select = document.getElementById('nom'); const autre = document.getElementById('autreNomRando'); return (select && select.value==='autre') ? (autre ? autre.value.trim() : '') : (select ? select.value : (document.getElementById('rechercheRando').value || '')); }
function getValeurOuRouge(elementId, isText=false){ const el=document.getElementById(elementId); const valeur = el ? (isText ? el.textContent : el.value) : ''; return (valeur && String(valeur).trim()) ? valeur : '<span style="color:red">Non renseign√©</span>'; }
function getLibelleTechnicite(valeur){ const niveaux=["Facile","Assez Facile","Peu Difficile","Assez Difficile","üòÖ Difficile"]; return niveaux[valorToIndex(valeur)] || "Non renseign√©"; }
function getLibelleRisque(valeur){ const niveaux=["Faible","Assez Faible","Peu √âlev√©","Assez √âlev√©","üòÖ √âlev√©"]; return niveaux[valorToIndex(valeur)] || "Non renseign√©"; }
function valorToIndex(v){ return (typeof v==='number' && v>=1 && v<=5) ? v-1 : -1; }

/* --- fonction principale : g√©n√®re le texte -> s√©curis√©e --- */
function genererTexte(){
  const nomRando = getNomRando() || '<span style="color:red">Non renseign√©</span>';
  const dateVal = document.getElementById("date").value;
  const dateFormatted = dateVal ? new Date(dateVal).toLocaleDateString("fr-FR") : '<span style="color:red">Non renseign√©</span>';
  const jour = document.getElementById("jour-semaine").textContent || '';

  const selectLieu = document.getElementById("lieu");
  let lieuRV = '<span style="color:red">Non renseign√©</span>';
  if(selectLieu){
    if(selectLieu.value === 'autre'){ const autreLieu = document.getElementById('autreLieu'); if(autreLieu && autreLieu.value.trim()) lieuRV = autreLieu.value.trim(); }
    else if(selectLieu.value) lieuRV = selectLieu.value;
  }

  const heureRV = getValeurOuRouge("heure-rv");
  const heureDepart = document.getElementById("heure-depart").textContent || '<span style="color:red">Non renseign√©</span>';
  const description = getValeurOuRouge("description");
  const trajetkm = getValeurOuRouge("trajet-km");
  const parkingDepart = getValeurOuRouge("parking-depart");
  const totalTrajet = document.getElementById("total-trajet")?.textContent || "0";
  const coutAutoroute = document.getElementById("cout-autoroute")?.value || "0";
  const coutTotal = document.getElementById("cout-total")?.textContent || "0";
  const covoit4 = document.getElementById("covoit4")?.textContent || "0";
  const covoit5 = document.getElementById("covoit5")?.textContent || "0";
  const km = document.getElementById("km")?.value || "0";
  const denivele = document.getElementById("denivele")?.value || "0";
  const duree = getValeurOuRouge("duree");
  const ibp = document.getElementById("ibp")?.value || "0";
  const effort = document.getElementById("effort")?.textContent || '<span style="color:red">Non renseign√©</span>';

  const techniciteValeur = parseInt(document.getElementById("technicite")?.value) || 0;
  const technicite = getLibelleTechnicite(techniciteValeur);
  const risqueValeur = parseInt(document.getElementById("risque")?.value) || 0;
  const risque = getLibelleRisque(risqueValeur);
  const remarques = getValeurOuRouge("remarques");
  const organisateur = document.getElementById("organisateur-label")?.textContent || '<span style="color:red">Non renseign√©</span>';
  const blocK = getValeurOuRouge("bloc");
  let resumeMeteo = "üå§Ô∏è M√©t√©o pr√©vue : <span style='color:red'>Non disponible</span>";
let alerteVent = "";

if (window.meteoJourRando) {
  const m = window.meteoJourRando;

  const ventTxt = (m.vent !== null && m.vent !== undefined)
    ? `üí® Vent ${m.vent} km/h`
    : "üí® Vent N/D";

  const rafalesTxt = (m.rafales !== null && m.rafales !== undefined)
    ? `üå™ Rafales ${m.rafales} km/h`
    : "";

  resumeMeteo =
    `üå§Ô∏è M√©t√©o pr√©vue le ${formatDateFR(m.date)} (fournie √† titre indicatif): ` +
    `${m.label}, ${m.tmin}¬∞C / ${m.tmax}¬∞C, ` +
    `‚òî ${m.pluie}% ‚óè ${ventTxt} ‚óè ${rafalesTxt}`;

  if (m.rafales >= 60) {
    alerteVent = " ‚ö†Ô∏è ATTENTION : rafales fortes, vigilance randonn√©e !";
  }
}


  const resume = `
Feuille de route : ${jour} ${dateFormatted} ‚Äî ${nomRando}
Nom de la randonn√©e : ${nomRando}
üìÜ Date de la randonn√©e : ${dateFormatted}<br>${resumeMeteo}<br>${alerteVent}

üÖøÔ∏è Parking Covoiturage : ${lieuRV}
üïû Heure de rendez-vous : ${heureRV}
üîî Heure de D√©part : ${heureDepart}

Trajet sugg√©r√©: ${description}

Kilom√©trage voiture A/R : ${trajetkm} km
üèÅ Parking de D√©part de la randonn√©e : ${parkingDepart}
${lastMapLink ? `üìç Lien Google Maps : ${lastMapLink}` : ""}
${window.lastLat ? `<br>üìå Coordonn√©es GPS : ${window.lastLat}, ${window.lastLon}` : ""}<br>
Co√ªt du Trajet : ${totalTrajet} ‚Ç¨
Co√ªt de l'Autoroute : ${coutAutoroute} ‚Ç¨
Co√ªt Trajet Total : ${coutTotal} ‚Ç¨
‚úÖ Covoiturage (par 4) : ${covoit4} ‚Ç¨
‚úÖ Covoiturage (par 5) : ${covoit5} ‚Ç¨

Distance de la Randonn√©e : ‚âÉ${km} km
üòã D√©nivel√© positif : ‚âÉ${denivele} m
‚è±Ô∏è Dur√©e totale: ‚âÉ${duree}

IBP : ${ibp} (HKG)
E: ${effort}, T: ${techniciteValeur} (${technicite}), R : ${risqueValeur} (${risque})

üìå Remarques et particularit√©s : ${remarques}

üö∂‚Äç‚ôÇÔ∏èüö∂üèª‚Äç‚ôÄÔ∏èAnimateur-trice : ${organisateur}

Les param√®tres de la randonn√©e sont donn√©s √† titre indicatif uniquement. 
Ils peuvent varier en fonction des applications GPS.

Inscription aupr√®s de l'animateur-trice la veille avant 19h par SMS.
L'animateur-trice se r√©serve le droit de modifier le circuit.

√âQUIPEMENT : Les chaussures de randonn√©e montantes et les b√¢tons de marche sont obligatoires. 
Pr√©voir des v√™tements de protection (vent, pluie, froid), un sac √† dos avec pique-nique et de l'eau en quantit√© suffisante, ainsi que sa propre pharmacie.
`.trim();


  const resultatDiv = document.getElementById("resultat");
  if(!resultatDiv){ alert("Erreur : conteneur du r√©sum√© introuvable."); return; }
  // resultatDiv.innerHTML = resume;
  resultatDiv.innerHTML = resume.replace(/\n/g, "<br>");

  // accessible : focus sur r√©sultat
  resultatDiv.focus?.();
}

/* --- copies / envoi --- */
function validerNumerique(id){
  const champ=document.getElementById(id);
  if(!champ) return;
  const valeur = champ.value.trim();
  const messageErreurId = id + "-erreur"; let messageErreur = document.getElementById(messageErreurId);
  if(!messageErreur){ messageErreur = document.createElement("p"); messageErreur.id = messageErreurId; messageErreur.className = "message-erreur"; messageErreur.style.color="white"; messageErreur.style.backgroundColor="red"; messageErreur.style.padding="5px"; messageErreur.style.borderRadius="3px"; messageErreur.style.fontSize="0.9em"; messageErreur.style.marginTop="5px"; champ.parentNode.insertBefore(messageErreur, champ.nextSibling); }
  if(valeur==="" || isNaN(valeur)){ messageErreur.textContent = "Valeurs num√©riques uniquement"; messageErreur.style.display = "block"; } else { messageErreur.style.display = "none"; }
}


function getCanvasBase64() {
  const canvas = document.getElementById("elevationChart");
  if (!canvas || canvas.width === 0 || canvas.height === 0) {
    return null;
  }
  return canvas.toDataURL("image/png");
}
function getCanvasBase64WithFooter() {
  const canvas = document.getElementById("elevationChart");
  if (!canvas) return null;

  const date = document.getElementById("date")?.value || "";
  const dateFormatted = date
    ? new Date(date).toLocaleDateString("fr-FR")
    : "";

  const rando = typeof getNomRando === "function"
    ? getNomRando()
    : "Randonn√©e";
  const organisateur =
  document.getElementById("organisateur")?.value?.trim() || "";
  const footerText = `${rando} ‚Äî ${dateFormatted} ‚Äî ${organisateur}`;
  const footerHeight = 50;

  const exportCanvas = document.createElement("canvas");
  exportCanvas.width = canvas.width;
  exportCanvas.height = canvas.height + footerHeight;

  const ctx = exportCanvas.getContext("2d");

  // fond blanc
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

  // courbe
  ctx.drawImage(canvas, 0, 0);

  // texte
  ctx.font = "16px Arial";
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";

  ctx.fillText(
    footerText,
    exportCanvas.width / 2,
    canvas.height + 32
  );

  return exportCanvas.toDataURL("image/png");
}

async function envoyerEmail() {
  const date = document.getElementById("date").value || "";
  const dateFormatted = date
    ? new Date(date).toLocaleDateString("fr-FR")
    : "";

  const jour = document.getElementById("jour-semaine").textContent || "";
  const lieu = getNomRando() || "Non renseign√©";
  const resume = document.getElementById("resultat").innerText || "";

  const sujet = `${jour} ${dateFormatted} ${lieu}`;

  const corpsMail =
    "Bonjour La Marmotte,\n\n" +
    "Voici ma feuille de route.\n\n" +
    resume +
    "\n\nCordialement.";

  const image = getCanvasBase64WithFooter();
if (!image) {
  alert("La courbe n‚Äôest pas encore pr√™te. G√©n√©rez le profil avant l‚Äôenvoi.");
  return;
}

  await fetch("/api/send-mail", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    subject: sujet,
    message: corpsMail,
    imageBase64: image
  })
});


  alert("Mail envoy√© avec la courbe en pi√®ce jointe ‚úÖ");
}


</script>

<script>
// === Leaflet & Nominatim integration (replaces previous updateParkingMap / mettreAJourDistance) ===

// --- variables globales ---
  // --- Mise √† jour automatique du point de d√©part (parking covoiturage) ---
let lastMapLink = "";
window.lastLat = null;
window.lastLon = null;
window.leafletMap = null;
window.leafletMarker = null;
window.routeLayer = null;

// HOME_LAT / HOME_LON can be updated dynamically from the parking covoiturage select
let HOME_LAT = 43.88808;
let HOME_LON = 4.84882;

// --- Mise √† jour automatique du point de d√©part (parking covoiturage) ---
async function setHomeFromParking() {
    const select = document.getElementById("lieu");
    const autre = document.getElementById("autreLieu");

    if (!select) return;

    let texte = "";
    if (select.value === "autre") {
        if (!autre || !autre.value.trim()) return;
        texte = autre.value.trim();
    } else {
        texte = select.value;
    }
    if (!texte) return;

    try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(texte)}`;
        const r = await fetch(url, { headers: { "Accept-Language": "fr" } });
        const j = await r.json();
        if (!j || !j.length) {
            console.warn("Parking covoiturage introuvable :", texte);
            return;
        }
        HOME_LAT = parseFloat(j[0].lat);
        HOME_LON = parseFloat(j[0].lon);
        console.log("NOUVEAU point de d√©part COVOIT =", HOME_LAT, HOME_LON);
        if (window.lastLat && window.lastLon) {
            updatePosition(window.lastLat, window.lastLon);
        }
    } catch (e) {
        console.error("Erreur en g√©ocodant le parking covoiturage :", e);
    }
}

function calculerCouts(){
  const km = parseFloat(document.getElementById('trajet-km').value) || 0;
  const autoroute = parseFloat(document.getElementById('cout-autoroute').value) || 0;
  const totalTrajet = km * 0.3;
  const coutTotal = totalTrajet + autoroute;
  const elTotal = document.getElementById('total-trajet');
  const elCout = document.getElementById('cout-total');
  const el4 = document.getElementById('covoit4');
  const el5 = document.getElementById('covoit5');
  if(elTotal) elTotal.textContent = totalTrajet.toFixed(2);
  if(elCout) elCout.textContent = coutTotal.toFixed(2);
if(el4) el4.textContent = (Math.round((coutTotal/4) * 10) / 10).toFixed(1);
if(el5) el5.textContent = (Math.round((coutTotal/5) * 10) / 10).toFixed(1);
}

async function getDrivingRoute(lat1, lon1, lat2, lon2){
  const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('OSRM error ' + r.status);
    const j = await r.json();
    if(j.routes && j.routes.length > 0){
      return {
        distance_km: j.routes[0].distance / 1000,
        coords: j.routes[0].geometry.coordinates.map(c => [c[1], c[0]])
      };
    }
  }catch(e){ console.warn('getDrivingRoute error', e); }
  return null;
}

function drawRoute(coords){
  if(!window.leafletMap) return;

  if(window.routeLayer){
    try{
      window.leafletMap.removeLayer(window.routeLayer);
    }catch(e){}
    window.routeLayer = null;
  }

  if(coords && coords.length){
    window.routeLayer = L.polyline(coords, {
      color:'#0074D9',
      weight:4,
      opacity:0.9
    }).addTo(window.leafletMap);

    // ‚úÖ Le bouton appara√Æt quand une route existe
    setRecenterButtonVisible(true);

  } else {
    setRecenterButtonVisible(false);
  }
}


function updatePosition(lat, lon){
  window.lastLat = lat;
  window.lastLon = lon;
  lastMapLink = `https://www.google.com/maps?q=${lat},${lon}`;
  const captionEl = document.getElementById('parkingMapCaption');
  if(captionEl) captionEl.innerHTML = `<strong>GPS :</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)} ‚Äî <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" rel="noopener">Ouvrir dans Google Maps</a>`;

  getDrivingRoute(HOME_LAT, HOME_LON, lat, lon).then(res =>{
    if(res){
      const kmAR = (res.distance_km * 2).toFixed(1);
      const el = document.getElementById("trajet-km");
      if(el) el.value = kmAR;
      drawRoute(res.coords);
    } else {
      // fallback: haversine
      const R = 6371;
      const dLat = (lat - HOME_LAT) * Math.PI/180;
      const dLon = (lon - HOME_LON) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(HOME_LAT*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)**2;
      const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const el = document.getElementById("trajet-km");
      if(el) el.value = (d*2).toFixed(1);
      try{ if(window.routeLayer){ window.leafletMap.removeLayer(window.routeLayer); window.routeLayer = null; } }catch(e){}
    }
    calculerCouts();
  });
}

function updateParkingMap(){
  const query = document.getElementById('parking-depart').value.trim();
  if(query.length < 3) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(results => {
      if(!results || !results.length){
        console.warn("Nominatim : aucun r√©sultat");
        return;
      }

      const lat = parseFloat(results[0].lat);
      const lon = parseFloat(results[0].lon);

      /* ===== METEO ===== */
      updateOpenMeteo(lat, lon);

      /* ===== CARTE ===== */
      const mapDiv = document.getElementById('parkingMap');
      if(mapDiv){
        mapDiv.style.display = 'block';
        mapDiv.style.width = '100%';
        mapDiv.style.height = '400px';
      }

      if(!window.leafletMap){
        window.leafletMap = L.map('parkingMap').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
          maxZoom:19,
          attribution:'&copy; OpenStreetMap contributors'
        }).addTo(window.leafletMap);
      } else {
        window.leafletMap.setView([lat, lon], 13);
      }

      /* ===== MARKER ===== */
      if(!window.leafletMarker){
        window.leafletMarker = L.marker([lat, lon], {draggable:true}).addTo(window.leafletMap);
        window.leafletMarker.on('dragend', e =>{
          const p = e.target.getLatLng();

          // üîÅ TRAC√â + KM + METEO
          updatePosition(p.lat, p.lng);
          updateOpenMeteo(p.lat, p.lng);
        });
      } else {
        window.leafletMarker.setLatLng([lat, lon]);
      }

      /* ===== üî• TRAC√â A/R + DISTANCE üî• ===== */
      updatePosition(lat, lon);

    })
    .catch(err => {
      console.error("Nominatim error:", err);
    });
}

// ‚úÖ Recentrage manuel du trajet (bouton)
function recenterRoute(){
  if(window.leafletMap && window.routeLayer){
    try{
      window.leafletMap.fitBounds(window.routeLayer.getBounds(), {padding:[40,40]});
    }catch(e){
      console.error("Erreur recentrage :", e);
      alert("Impossible de recentrer le trajet.");
    }
  } else {
    alert("Aucun trajet √† afficher.");
  }
}

// ‚úÖ Affichage du bouton uniquement quand une route existe
function setRecenterButtonVisible(visible){
  const btn = document.getElementById("btn-recentrer-trajet");
  if(!btn) return;
  btn.style.display = visible ? "inline-block" : "none";
}
function weatherLabel(code){
  if(code === 0) return "‚òÄÔ∏è Soleil";
  if([1,2].includes(code)) return "üå§Ô∏è Peu nuageux";
  if(code === 3) return "‚òÅÔ∏è Couvert";
  if([45,48].includes(code)) return "üå´Ô∏è Brouillard";
  if([51,53,55,61,63,65].includes(code)) return "üåßÔ∏è Pluie";
  if([71,73,75].includes(code)) return "‚ùÑÔ∏è Neige";
  if(code >= 95) return "‚õàÔ∏è Orage";
  return "üå•Ô∏è Variable";
}
function formatDateFR(dateStr){
  const d = new Date(dateStr);
  return d.toLocaleDateString("fr-FR");
}

function updateOpenMeteo(lat, lon){
  window.meteoJourRando = null;

  const url =
    "https://api.open-meteo.com/v1/forecast" +
    `?latitude=${lat}&longitude=${lon}` +
    "&daily=temperature_2m_max,temperature_2m_min," +
    "precipitation_sum,precipitation_probability_max,weathercode," +
    "windspeed_10m_max,windgusts_10m_max" +
    "&forecast_days=7" +
    "&timezone=Europe/Paris";

  fetch(url)
    .then(r => r.json())
    .then(data => {

      const bloc = document.getElementById("meteo-openmeteo");
      if(!bloc) return;

      bloc.style.display = "block";

      let html = "<ul>";
      const dateRando = getDateRando();

      window.meteoJourRando = null;

      data.daily.time.forEach((day, i) => {

        const dayNorm = normalizeDate(day);
        const isRandoDay = dateRando && dayNorm === dateRando;
        const cls = isRandoDay ? "meteo-rando-day" : "";

        // valeurs s√©curis√©es
        const tmin = data.daily.temperature_2m_min?.[i];
        const tmax = data.daily.temperature_2m_max?.[i];
        const pluie = data.daily.precipitation_probability_max?.[i];
        const vent = data.daily.windspeed_10m_max?.[i];
        const rafales = data.daily.windgusts_10m_max?.[i];
        const label = weatherLabel(data.daily.weathercode?.[i]);

        // sauvegarde jour de rando
        if(isRandoDay){
          window.meteoJourRando = {
            date: day,
            label,
            tmin,
            tmax,
            pluie,
            vent,
            rafales
          };
        }

        html += `
          <li class="${cls}">
            <b>${formatDateFR(day)}</b> ‚óè ${label}
            ‚óè ${tmin ?? "‚Äî"}¬∞C / ${tmax ?? "‚Äî"}¬∞C
            ‚óè ‚òî ${pluie ?? "‚Äî"} %
            ‚óè üí® ${vent ?? "‚Äî"} km/h
            ‚óè üå™ ${rafales ?? "‚Äî"} km/h
          </li>`;
      });

      html += "</ul>";
      bloc.innerHTML = html;
    })
    .catch(err => {
      console.error("Erreur Open-Meteo", err);
    });
}
// === Saisie assist√©e Parking d√©part randonn√©e ===
const parkingInput = document.getElementById("parking-depart");
const datalist = document.getElementById("parkings-list");

let timeoutParking = null;

parkingInput.addEventListener("input", () => {
  const query = parkingInput.value.trim();

  // On √©vite les requ√™tes inutiles saisie 6 lettres
  if (query.length < 4 ) return;

  clearTimeout(timeoutParking);

  timeoutParking = setTimeout(() => {
    fetch(
      `https://nominatim.openstreetmap.org/search?` +
        `format=json` +
        `&q=parking ${encodeURIComponent(query)}` +
        `&limit=5` +
        `&countrycodes=fr`
    )
      .then((res) => res.json())
      .then((data) => {
        datalist.innerHTML = "";

        data.forEach((place) => {
          const option = document.createElement("option");
          option.value = place.display_name;
          datalist.appendChild(option);
        });
      })
      .catch((err) => {
        console.error("Erreur saisie assist√©e parking", err);
      });
  }, 400); // d√©lai anti-spam
});

</script>

<script>
function secondesVersHHMM(sec) {
  const secondes = Number(sec);
  if (!Number.isFinite(secondes) || secondes <= 0) return "";
  const h = Math.floor(secondes / 3600);
  const m = Math.floor((secondes % 3600) / 60);
  return `${h}:${String(m).padStart(2, "0")}`;
}

function hhmmssVersHHMM(str) {
  if (!str || typeof str !== "string") return "";
  const parts = str.split(":");
  if (parts.length < 2) return "";
  return parts[0].padStart(2, "0") + ":" + parts[1].padStart(2, "0");
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let elevationChartInstance = null;
</script>


<!-- === IBPindex GPX API === -->
<script>

  function hhmmssVersHHMM(str) {
  if (!str || typeof str !== "string") return "";
  const parts = str.split(":");
  if (parts.length < 2) return "";
  return parts[0].padStart(2, "0") + ":" + parts[1].padStart(2, "0");
}

  function exploiterIBP(javascript_json){

  let modality = javascript_json.detectedmodality;

  // Cas IBP : modalit√© non d√©tect√©e automatiquement
  if (modality === "manually" || !javascript_json[modality]) {

    if (javascript_json.hiking) {
      modality = "hiking";
    } else if (javascript_json.trekking) {
      modality = "trekking";
    } else {
      console.warn("Aucune modalit√© randonn√©e disponible", javascript_json);
      return;
    }
  }

  const data = javascript_json[modality];


  if(data.totlengthkm){
    km.value = Number(data.totlengthkm).toFixed(1);
    ajusterLargeur(km);
  }

  if(data.accuclimb){
    denivele.value = Math.round(data.accuclimb);
    ajusterLargeur(denivele);
  }

 // === Dur√©e totale (IBP + fallback GPX) ===
let duree = "";

// ‚úÖ IBP en priorit√© (hh:mm:ss)
if (typeof data.totaltime === "string") {
  duree = hhmmssVersHHMM(data.totaltime);
} else if (typeof data.movingtime === "string") {
  duree = hhmmssVersHHMM(data.movingtime);
}


if (duree) {
  const champDuree = document.getElementById("duree");
  champDuree.value = duree;
  ajusterLargeur(champDuree);
} else {
  console.warn("Dur√©e introuvable (IBP + GPX)", data);
}
console.log("Dur√©e IBP re√ßue :", data.totaltime);



  if(data.ibp){
    ibp.value = Math.round(data.ibp);
    afficherIBP();
  }
}

$(function(){

  $("#formuploadajax").on("submit", function(e){
    e.preventDefault();

    $("#gpx-status").text("‚è≥ Analyse du fichier GPX en cours...");

    const formData = new FormData(this);

    $.ajax({
      url: "https://ibp-proxy.vercel.app/api/ibp",
      type: "POST",
      dataType: "json",
      data: formData,
      contentType: false,
      processData: false
    })
    .done(function(data){

  console.log("R√©ponse IBP brute :", data);

  exploiterIBP(data);

  $("#gpx-status").text("‚úÖ GPX analys√© avec succ√®s");

})

    .fail(err=>{
      console.error("Erreur IBPindex:", err);
      $("#gpx-status").text("‚ùå Erreur IBPindex");
    });

  });

});
</script>
<script>
// let elevationChartInstance = null;

document.getElementById("formuploadajax").addEventListener("submit", function (e) {
  e.preventDefault();

  const fileInput = document.getElementById("file");
  if (!fileInput.files.length) return;

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function (event) {
    const gpxText = event.target.result;
    parseGPXandDrawProfile(gpxText);
  };

  reader.readAsText(file);
});
</script>
<script>
const whiteBackgroundPlugin = {
  id: 'whiteBackground',
  beforeDraw(chart) {
    const ctx = chart.ctx;
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, chart.width, chart.height);
    ctx.restore();
  }
};
</script>
<script>
const verticalCursorPlugin = {
  id: 'verticalCursor',
  afterDraw(chart) {
    const tooltip = chart.tooltip;
    if (!tooltip || !tooltip.getActiveElements().length) return;

    const ctx = chart.ctx;
    const chartArea = chart.chartArea;
    const activePoint = tooltip.getActiveElements()[0];
    const x = activePoint.element.x;

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x, chartArea.top);
    ctx.lineTo(x, chartArea.bottom);

    /* üé® OPTIONS ESTH√âTIQUES ICI */
    ctx.lineWidth = 2;                     // √©paisseur
    ctx.strokeStyle = 'rgba(0,0,0,0.25)';  // couleur
    ctx.setLineDash([6, 4]);               // pointill√©
    // ctx.setLineDash([]);                // ‚Üê ligne pleine (alternative)

    ctx.stroke();
    ctx.restore();
  }
};
</script>


<script>
// üî∏ Fonction couleur pente (√† coller UNE SEULE FOIS)
function couleurPente(pente, maxSlopeIBP) {

  const ref = maxSlopeIBP && maxSlopeIBP > 0 ? maxSlopeIBP : 30;
  const t = Math.min(Math.abs(pente) / ref, 1);

  if (pente < 0) {
    // üîµ DESCENTE : bleu clair ‚Üí bleu fonc√©
    const b = 255;
    const g = Math.round(200 * (1 - t));
    return `rgb(0,${g},${b})`;
  } else {
    // üü†‚Üíüî¥ MONT√âE : orange ‚Üí rouge
    const r = 255;
    const g = Math.round(165 * (1 - t));
    return `rgb(${r},${g},0)`;
  }
}

function penteLiss√©e(index, elevations, distances, windowSize = 5) {
  if (index < windowSize) return 0;

  const dz = elevations[index] - elevations[index - windowSize];
  const dd = (distances[index] - distances[index - windowSize]) * 1000; // km ‚Üí m

  return dd > 0 ? (dz / dd) * 100 : 0;
}

  // üî∏ Fonction principale GPX 
function parseGPXandDrawProfile(gpxText, maxSlopeIBP) {

  const parser = new DOMParser();
  const xml = parser.parseFromString(gpxText, "application/xml");
  const trackPoints = xml.getElementsByTagName("trkpt");

  const elevations = [];
  const distances = [];
  const segmentColors = [];
  const segmentPentes = [];

  let totalDistance = 0;
  let lastLat = null;
  let lastLon = null;

  for (let i = 0; i < trackPoints.length; i++) {
    const pt = trackPoints[i];
    const lat = parseFloat(pt.getAttribute("lat"));
    const lon = parseFloat(pt.getAttribute("lon"));
    const eleNode = pt.getElementsByTagName("ele")[0];
    if (!eleNode) continue;

    const ele = parseFloat(eleNode.textContent);

    if (lastLat !== null) {
      const dist = haversine(lastLat, lastLon, lat, lon) * 1000; // m
      totalDistance += dist;
    }

    elevations.push(ele);
    distances.push(totalDistance / 1000); // km NUM√âRIQUE

    // üî• calcul pente liss√©e APRES insertion
    const index = elevations.length - 1;
    const pente = penteLiss√©e(index, elevations, distances);
    segmentPentes.push(pente);

    if (index > 0) {
      segmentColors.push(couleurPente(pente, maxSlopeIBP));
    }

    lastLat = lat;
    lastLon = lon;
  }

  drawElevationChart(distances, elevations, segmentColors, segmentPentes);
}
// üî∏ haversine
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;

  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
<script>
function drawElevationChart(distances, elevations, segmentColors, segmentPentes) {

  const canvas = document.getElementById("elevationChart");
  const ctx = canvas.getContext("2d");

  if (elevationChartInstance) elevationChartInstance.destroy();

  elevationChartInstance = new Chart(ctx, {
    type: "line",

    data: {
      labels: distances.map(d => d.toFixed(2)),
      datasets: [{
        data: elevations,
        borderWidth: 3,
        pointRadius: 0,
        fill: false,
        tension: 0.25,
        segment: {
          borderColor: ctx =>
            segmentColors[ctx.p0DataIndex] || '#888'
        }
      }]
    },

    options: {
      responsive: true,
      maintainAspectRatio: false,

      interaction: {
        mode: 'index',
        intersect: false
      },

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const i = ctx.dataIndex;
              const pente = segmentPentes[i] ?? 0;
              return `Altitude : ${Math.round(ctx.raw)} m ‚Äî Pente : ${pente.toFixed(1)} %`;
            }
          }
        }
      },

      scales: {
        x: { title: { display: true, text: "Distance (km)" } },
        y: { title: { display: true, text: "Altitude (m)" } }
      }
    },

    plugins: [
      whiteBackgroundPlugin,
      verticalCursorPlugin
    ]
  });
}
</script>


<script>
const titreExportPlugin = {
  id: 'titreExportPlugin',
  afterDraw(chart, args, options) {
    const { ctx, chartArea, width, height } = chart;

    if (!options || !options.text) return;

    ctx.save();
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";

    // position sous la zone du graphique
    const y = chartArea.bottom + 20;

    ctx.fillText(options.text, width / 2, y);
    ctx.restore();
  }
};
</script>

<!-- === FIN IBPindex GPX API & noms auto du jpg export√© === -->

<script>
document.getElementById("exportProfilJPG").addEventListener("click", function () {

  if (!elevationChartInstance) {
    alert("Profil non g√©n√©r√©");
    return;
  }

  /* ===== r√©cup√©ration date ===== */
  const dateInput = document.getElementById("date")?.value;
  const dateFormatted = dateInput
    ? new Date(dateInput).toLocaleDateString("fr-FR")
    : "Date non renseign√©e";

  /* ===== r√©cup√©ration nom rando ===== */
  const nomRando =
    document.getElementById("nom")?.value === "autre"
      ? document.getElementById("autreNomRando")?.value
      : document.getElementById("nom")?.value ||
        document.getElementById("rechercheRando")?.value ||
        "Randonn√©e";

  const titre = `${dateFormatted} ‚Äî ${nomRando}`;

  /* ===== canvas source ===== */
  const sourceCanvas = document.getElementById("elevationChart");

  /* ===== canvas export (plus haut) ===== */
  const exportCanvas = document.createElement("canvas");
  const margeBas = 40; // espace pour le titre

  exportCanvas.width = sourceCanvas.width;
  exportCanvas.height = sourceCanvas.height + margeBas;

  const ctx = exportCanvas.getContext("2d");

  /* fond blanc */
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

  /* copier le graphique */
  ctx.drawImage(sourceCanvas, 0, 0);

  /* √©crire le titre */
  ctx.font = "bold 14px Arial";
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";
  ctx.fillText(
    titre,
    exportCanvas.width / 2,
    sourceCanvas.height + 26
  );

  /* ===== export ===== */
  const nomFichier = `${dateFormatted}_${nomRando}`
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9_-]/g, "_")
    .replace(/_+/g, "_") + ".jpg";

  const jpg = exportCanvas.toDataURL("image/jpeg", 0.95);

  const a = document.createElement("a");
  a.href = jpg;
  a.download = nomFichier;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});
</script>



<script>
window.addEventListener("resize", () => {
  if (elevationChartInstance) {
        elevationChartInstance.update();
  }
});
</script>


</body>
</html>
